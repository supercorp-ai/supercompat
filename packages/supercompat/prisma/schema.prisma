// Prisma schema for supercompat package

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Thread {
  id          String     @id @default(dbgenerated("gen_random_uuid()"))
  assistantId String
  assistant   Assistant  @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  metadata    Json?
  messages    Message[]
  runs        Run[]
  runSteps    RunStep[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([assistantId])
  @@index([createdAt(sort: Desc)])
}

enum MessageRole {
  USER
  ASSISTANT
}

enum MessageStatus {
  IN_PROGRESS
  INCOMPLETE
  COMPLETED
}

model Message {
  id               String        @id @default(dbgenerated("gen_random_uuid()"))
  threadId         String
  thread           Thread        @relation(fields: [threadId], references: [id], onDelete: Cascade)
  role             MessageRole
  content          Json
  status           MessageStatus @default(COMPLETED)
  assistantId      String?
  assistant        Assistant?    @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  runId            String?
  run              Run?          @relation(fields: [runId], references: [id], onDelete: Cascade)
  completedAt      DateTime?
  incompleteAt     DateTime?
  incompleteDetails Json?
  attachments      Json[]        @default([])
  metadata         Json?
  toolCalls        Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([threadId])
  @@index([createdAt(sort: Desc)])
}

enum RunStatus {
  QUEUED
  IN_PROGRESS
  REQUIRES_ACTION
  CANCELLING
  CANCELLED
  FAILED
  COMPLETED
  EXPIRED
}

model Run {
  id                String     @id @default(dbgenerated("gen_random_uuid()"))
  threadId          String
  thread            Thread     @relation(fields: [threadId], references: [id], onDelete: Cascade)
  assistantId       String
  assistant         Assistant  @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  status            RunStatus
  requiredAction    Json?
  lastError         Json?
  expiresAt         Int
  startedAt         Int?
  cancelledAt       Int?
  failedAt          Int?
  completedAt       Int?
  model             String
  instructions      String
  tools             Json[]     @default([])
  metadata          Json?
  usage             Json?
  truncationStrategy Json      @default("{ \"type\": \"auto\" }")
  responseFormat    Json       @default("{ \"type\": \"text\" }")
  runSteps          RunStep[]
  messages          Message[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

enum RunStepType {
  MESSAGE_CREATION
  TOOL_CALLS
}

enum RunStepStatus {
  IN_PROGRESS
  CANCELLED
  FAILED
  COMPLETED
  EXPIRED
}

model RunStep {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  threadId    String
  thread      Thread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  assistantId String
  assistant   Assistant    @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  runId       String
  run         Run          @relation(fields: [runId], references: [id], onDelete: Cascade)
  type        RunStepType
  status      RunStepStatus
  stepDetails Json
  lastError   Json?
  expiredAt   Int?
  cancelledAt Int?
  failedAt    Int?
  completedAt Int?
  metadata    Json?
  usage       Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([threadId, runId, type, status])
  @@index([createdAt(sort: Asc)])
}

model Assistant {
  id           String    @id @default(dbgenerated("gen_random_uuid()"))
  modelSlug    String?
  instructions String?
  name         String?
  description  String?
  metadata     Json?
  threads      Thread[]
  runs         Run[]
  runSteps     RunStep[]
  messages     Message[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// Azure Agents-specific table for storing function tool call outputs
// since Azure API doesn't persist these after submission
model AzureAgentsFunctionOutput {
  id           String   @id @default(dbgenerated("gen_random_uuid()"))
  runId        String   // The run ID where the tool was called
  toolCallId   String   // The specific tool call ID
  output       String   // The output that was submitted
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([runId, toolCallId])
  @@index([runId])
  @@index([createdAt(sort: Desc)])
}

// ── Responses API Models ─────────────────────────────────────────

model Conversation {
  id          String     @id @default(dbgenerated("gen_random_uuid()"))
  metadata    Json?
  responses   Response[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum ResponseStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
  INCOMPLETE
}

enum TruncationType {
  AUTO
  LAST_MESSAGES
  DISABLED
}

model Response {
  id                          String           @id @default(dbgenerated("gen_random_uuid()"))
  conversationId              String?
  conversation                Conversation?    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  model                       String
  status                      ResponseStatus
  error                       Json?
  metadata                    Json?
  usage                       Json?
  instructions                String?
  temperature                 Float?
  topP                        Float?
  maxOutputTokens             Int?
  truncationType              TruncationType   @default(DISABLED)
  truncationLastMessagesCount Int?
  textFormatType              String?          @default("text")
  textFormatSchema            Json?
  input                       Json?
  outputItems                 ResponseOutputItem[]
  tools                       ResponseTool[]
  createdAt                   DateTime         @default(now())
  updatedAt                   DateTime         @updatedAt

  @@index([conversationId])
}

enum ResponseOutputItemType {
  MESSAGE
  FUNCTION_CALL
}

enum ResponseOutputItemStatus {
  IN_PROGRESS
  COMPLETED
  INCOMPLETE
}

model ResponseOutputItem {
  id          String                   @id @default(dbgenerated("gen_random_uuid()"))
  responseId  String
  response    Response                 @relation(fields: [responseId], references: [id], onDelete: Cascade)
  type        ResponseOutputItemType
  status      ResponseOutputItemStatus @default(IN_PROGRESS)
  role        String?
  content     Json?
  callId      String?
  name        String?
  arguments   String?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt

  @@index([responseId])
  @@index([createdAt(sort: Asc)])
}

enum ResponseToolType {
  FUNCTION
  FILE_SEARCH
  WEB_SEARCH
  CODE_INTERPRETER
  COMPUTER_USE
}

model ResponseTool {
  id                  String              @id @default(dbgenerated("gen_random_uuid()"))
  type                ResponseToolType
  responseId          String
  response            Response            @relation(fields: [responseId], references: [id], onDelete: Cascade)
  functionTool        ResponseFunctionTool?
  fileSearchTool      ResponseFileSearchTool?
  webSearchTool       ResponseWebSearchTool?
  codeInterpreterTool ResponseCodeInterpreterTool?
  computerUseTool     ResponseComputerUseTool?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([responseId])
}

model ResponseFunctionTool {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  name        String
  description String?
  parameters  Json
  strict      Boolean      @default(false)
  toolId      String       @unique
  tool        ResponseTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model ResponseFileSearchTool {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  vectorStoreIds String[]     @default([])
  maxNumResults  Int          @default(20)
  toolId         String       @unique
  tool           ResponseTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model ResponseWebSearchTool {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  toolId      String       @unique
  tool        ResponseTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model ResponseCodeInterpreterTool {
  id          String       @id @default(dbgenerated("gen_random_uuid()"))
  toolId      String       @unique
  tool        ResponseTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model ResponseComputerUseTool {
  id            String       @id @default(dbgenerated("gen_random_uuid()"))
  displayHeight Int          @default(720)
  displayWidth  Int          @default(1280)
  environment   String       @default("linux")
  toolId        String       @unique
  tool          ResponseTool @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}
